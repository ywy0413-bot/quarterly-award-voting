<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Award í‰ê°€í•˜ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .star {
            cursor: pointer;
            font-size: 3rem;
            transition: all 0.3s ease;
            filter: grayscale(100%);
            display: inline-block;
        }
        .star.active {
            filter: grayscale(0%) drop-shadow(0 0 8px rgba(251, 191, 36, 0.8));
            transform: scale(1.1);
        }
        .star:hover {
            filter: grayscale(0%);
            transform: scale(1.15);
        }
        @media (max-width: 640px) {
            .star {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-indigo-600 mb-6 md:mb-8">ğŸ† Award í‰ê°€í•˜ê¸°</h1>

            <!-- ì‚¬ìš©ì ì¸ì¦ í™”ë©´ -->
            <div id="loginScreen">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë¦„ ì„ íƒ</label>
                        <select id="userSelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-base">
                            <option value="">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">PIN (4ìë¦¬)</label>
                        <input type="number" id="pinInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-base" placeholder="4ìë¦¬ PIN ì…ë ¥">
                    </div>

                    <button id="loginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-bold py-3 md:py-4 rounded-lg transition text-base md:text-lg touch-manipulation">
                        ë¡œê·¸ì¸
                    </button>
                </div>
            </div>

            <!-- ë¡œë”© ìƒíƒœ -->
            <div id="loadingState" class="hidden text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">í‰ê°€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <!-- í‰ê°€ ì—†ìŒ ìƒíƒœ -->
            <div id="noAwardState" class="hidden text-center py-12">
                <p class="text-xl text-gray-600">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                <p class="text-sm text-gray-400 mt-2">ê´€ë¦¬ìê°€ í‰ê°€ë¥¼ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                <button id="logoutBtn1" class="mt-6 px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>

            <!-- ì´ë¯¸ í‰ê°€í•¨ ìƒíƒœ -->
            <div id="alreadyVotedState" class="hidden text-center py-12">
                <div class="text-6xl mb-4">âš ï¸</div>
                <p class="text-xl font-bold text-orange-600 mb-2">ì´ë¯¸ í‰ê°€ ì™„ë£Œ</p>
                <p class="text-gray-600 mb-1">ì´ AwardëŠ” ì´ë¯¸ í‰ê°€í•˜ì…¨ìŠµë‹ˆë‹¤</p>
                <p class="text-sm text-gray-400">ë‹¤ìŒ Award í‰ê°€ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                <button id="logoutBtn2" class="mt-6 px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>

            <!-- í‰ê°€ í¼ -->
            <div id="evaluationForm" class="hidden">
                <div class="bg-indigo-50 rounded-lg p-4 md:p-6 mb-6">
                    <div class="flex justify-between items-start mb-3">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800 flex-1" id="awardTitle"></h2>
                        <span class="text-xs md:text-sm text-indigo-600 font-semibold ml-2 whitespace-nowrap" id="quarterInfo"></span>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-semibold text-indigo-600">ğŸ‘‘ Impact Maker:</span>
                            <span id="impactMaker" class="text-gray-700 ml-2"></span>
                        </div>
                        <div>
                            <span class="font-semibold text-indigo-600">ğŸ’ª Core Member:</span>
                            <span id="coreMember" class="text-gray-700 ml-2"></span>
                        </div>
                        <div>
                            <span class="font-semibold text-indigo-600">âœ¨ Special Thanks:</span>
                            <span id="specialThanks" class="text-gray-700 ml-2"></span>
                        </div>
                    </div>
                </div>

                <div class="space-y-6 md:space-y-8">
                    <div>
                        <label class="block text-base md:text-lg font-semibold text-gray-800 mb-3 md:mb-4">
                            Q1. ì´ Awardì˜ ìœ í˜•ì€?
                        </label>
                        <div class="space-y-3">
                            <button class="award-type w-full bg-white border-2 border-gray-200 hover:border-indigo-500 active:border-indigo-600 hover:bg-indigo-50 text-gray-700 py-3 rounded-lg transition touch-manipulation" data-type="ë…¸ë ¥í˜•">
                                ğŸ’ª ë…¸ë ¥í˜•
                            </button>
                            <button class="award-type w-full bg-white border-2 border-gray-200 hover:border-indigo-500 active:border-indigo-600 hover:bg-indigo-50 text-gray-700 py-3 rounded-lg transition touch-manipulation" data-type="í˜ì‹ í˜•">
                                ğŸš€ í˜ì‹ í˜•
                            </button>
                            <button class="award-type w-full bg-white border-2 border-gray-200 hover:border-indigo-500 active:border-indigo-600 hover:bg-indigo-50 text-gray-700 py-3 rounded-lg transition touch-manipulation" data-type="ì°½ì¡°í˜•">
                                ğŸ¨ ì°½ì¡°í˜•
                            </button>
                            <button class="award-type w-full bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 py-3 rounded-lg transition touch-manipulation" data-type="ì˜ ëª¨ë¥´ê² ìŒ">
                                â“ ì˜ ëª¨ë¥´ê² ìŒ
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-base md:text-lg font-semibold text-gray-800 mb-3 md:mb-4">
                            Q2. ì´ Awardì˜ ì˜í–¥ë ¥ì€?
                        </label>
                        <div class="flex justify-center gap-1 md:gap-2 mb-2" id="starRating">
                            <span class="star" data-value="1">â­</span>
                            <span class="star" data-value="2">â­</span>
                            <span class="star" data-value="3">â­</span>
                            <span class="star" data-value="4">â­</span>
                            <span class="star" data-value="5">â­</span>
                        </div>
                        <p id="ratingText" class="text-center text-gray-500 text-sm mb-3 h-5"></p>
                        <button id="dontKnowImpact" class="w-full bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 py-2 rounded-lg transition touch-manipulation">
                            ì˜ ëª¨ë¥´ê² ìŒ
                        </button>
                    </div>

                    <button id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-bold py-3 md:py-4 rounded-lg transition text-base md:text-lg disabled:bg-gray-300 disabled:cursor-not-allowed touch-manipulation">
                        í‰ê°€ ì œì¶œí•˜ê¸°
                    </button>

                    <button id="logoutBtn3" class="w-full bg-gray-200 hover:bg-gray-300 active:bg-gray-400 text-gray-700 py-2 rounded-lg transition touch-manipulation">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>

            <!-- ì„±ê³µ ìƒíƒœ -->
            <div id="successState" class="hidden text-center py-12">
                <div class="text-6xl mb-4">âœ…</div>
                <p class="text-2xl font-bold text-green-600 mb-2">í‰ê°€ ì™„ë£Œ!</p>
                <p class="text-gray-600">ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, addDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC23FHBCtNPXXekdPgeYJZOyHU8SwIHWU",
            authDomain: "quarterly-award-voting.firebaseapp.com",
            projectId: "quarterly-award-voting",
            storageBucket: "quarterly-award-voting.firebasestorage.app",
            messagingSenderId: "1057289910549",
            appId: "1:1057289910549:web:e0d79116ad23e3f670911c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let selectedRating = 0;
        let selectedType = '';
        let currentAwardId = null;
        let currentUserId = null;
        let currentUserName = '';
        let usersCache = [];

        // PIN ì…ë ¥ 4ìë¦¬ ì œí•œ
        document.getElementById('pinInput').addEventListener('input', (e) => {
            if (e.target.value.length > 4) {
                e.target.value = e.target.value.slice(0, 4);
            }
        });

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ (í•œê¸€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬)
        onSnapshot(collection(db, 'users'), (snapshot) => {
            console.log('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œë¨:', snapshot.size, 'ëª…');
            usersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>';

            // í•œê¸€ ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            const sortedUsers = [...usersCache].sort((a, b) =>
                a.name.localeCompare(b.name, 'ko')
            );

            sortedUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name;
                userSelect.appendChild(option);
            });
        });

        // ë¡œê·¸ì¸
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const userName = document.getElementById('userSelect').value;
            const pin = document.getElementById('pinInput').value;

            console.log('ë¡œê·¸ì¸ ì‹œë„:', { userName, pin });

            if (!userName || !pin) {
                alert('ì´ë¦„ê³¼ PINì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (pin.length !== 4) {
                alert('PINì€ 4ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            // ì‚¬ìš©ì í™•ì¸
            const user = usersCache.find(u => u.name === userName && u.pin === pin);

            if (!user) {
                alert('ì´ë¦„ ë˜ëŠ” PINì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!');
                return;
            }

            currentUserId = user.id;
            currentUserName = user.name;
            console.log('ë¡œê·¸ì¸ ì„±ê³µ:', { currentUserId, currentUserName });

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');

            startAwardListener();
        });

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            currentUserId = null;
            currentUserName = '';
            selectedRating = 0;
            selectedType = '';
            currentAwardId = null;

            document.getElementById('userSelect').value = '';
            document.getElementById('pinInput').value = '';

            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('noAwardState').classList.add('hidden');
            document.getElementById('alreadyVotedState').classList.add('hidden');
            document.getElementById('evaluationForm').classList.add('hidden');
            document.getElementById('successState').classList.add('hidden');
        }

        document.getElementById('logoutBtn1').addEventListener('click', logout);
        document.getElementById('logoutBtn2').addEventListener('click', logout);
        document.getElementById('logoutBtn3').addEventListener('click', logout);

        // í˜„ì¬ í™œì„± Award ê°ì§€ ë° ì¤‘ë³µ í‰ê°€ ì²´í¬
        function startAwardListener() {
            const q = query(collection(db, 'awards'), where('isActive', '==', true));

            onSnapshot(q, async (snapshot) => {
                console.log('Award ìƒíƒœ ë³€ê²½ ê°ì§€');

                if (snapshot.empty) {
                    console.log('í™œì„± Award ì—†ìŒ');
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('noAwardState').classList.remove('hidden');
                    document.getElementById('evaluationForm').classList.add('hidden');
                    document.getElementById('alreadyVotedState').classList.add('hidden');
                    document.getElementById('successState').classList.add('hidden');
                } else {
                    const awardDoc = snapshot.docs[0];
                    const award = awardDoc.data();
                    currentAwardId = awardDoc.id;

                    console.log('í™œì„± Award:', award.title);

                    // ì´ë¯¸ í‰ê°€í–ˆëŠ”ì§€ í™•ì¸
                    const evaluationQuery = query(
                        collection(db, 'evaluations'),
                        where('awardId', '==', currentAwardId),
                        where('userId', '==', currentUserId)
                    );
                    const evaluationSnapshot = await getDocs(evaluationQuery);

                    if (!evaluationSnapshot.empty) {
                        console.log('ì´ë¯¸ í‰ê°€ ì™„ë£Œí•œ Award');
                        document.getElementById('loadingState').classList.add('hidden');
                        document.getElementById('noAwardState').classList.add('hidden');
                        document.getElementById('evaluationForm').classList.add('hidden');
                        document.getElementById('alreadyVotedState').classList.remove('hidden');
                        document.getElementById('successState').classList.add('hidden');
                    } else {
                        console.log('í‰ê°€ ê°€ëŠ¥í•œ Award');
                        // í¼ ì´ˆê¸°í™”
                        selectedRating = 0;
                        selectedType = '';
                        updateStars();
                        document.querySelectorAll('.award-type').forEach(b => {
                            b.classList.remove('border-indigo-500', 'bg-indigo-50');
                            b.classList.add('border-gray-200', 'bg-white');
                        });

                        // Award ì •ë³´ í‘œì‹œ
                        document.getElementById('awardTitle').textContent = award.title;
                        document.getElementById('quarterInfo').textContent = `${award.year || ''} ${award.quarter || ''}`.trim();
                        document.getElementById('impactMaker').textContent = award.impactMaker || '-';
                        document.getElementById('coreMember').textContent = award.coreMember || '-';
                        document.getElementById('specialThanks').textContent = award.specialThanks || '-';

                        document.getElementById('loadingState').classList.add('hidden');
                        document.getElementById('noAwardState').classList.add('hidden');
                        document.getElementById('evaluationForm').classList.remove('hidden');
                        document.getElementById('alreadyVotedState').classList.add('hidden');
                        document.getElementById('successState').classList.add('hidden');
                    }
                }
            });
        }

        // ë³„ì  UI
        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.dataset.value);
                updateStars();
            });
        });

        function updateStars() {
            const ratingText = document.getElementById('ratingText');
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });

            if (selectedRating > 0) {
                ratingText.textContent = `${selectedRating}ì  ì„ íƒë¨`;
                ratingText.classList.add('text-indigo-600', 'font-semibold');
                ratingText.classList.remove('text-gray-500');
            } else {
                ratingText.textContent = '';
                ratingText.classList.remove('text-indigo-600', 'font-semibold');
                ratingText.classList.add('text-gray-500');
            }
        }

        document.getElementById('dontKnowImpact').addEventListener('click', () => {
            selectedRating = -1;
            document.getElementById('ratingText').textContent = '"ì˜ ëª¨ë¥´ê² ìŒ" ì„ íƒë¨';
            document.getElementById('ratingText').classList.add('text-gray-600', 'font-semibold');
            document.getElementById('ratingText').classList.remove('text-indigo-600');
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
        });

        // Award ìœ í˜• ì„ íƒ
        document.querySelectorAll('.award-type').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedType = btn.dataset.type;
                document.querySelectorAll('.award-type').forEach(b => {
                    b.classList.remove('border-indigo-500', 'bg-indigo-50');
                    b.classList.add('border-gray-200', 'bg-white');
                });
                btn.classList.remove('border-gray-200', 'bg-white');
                btn.classList.add('border-indigo-500', 'bg-indigo-50');
            });
        });

        // í‰ê°€ ì œì¶œ
        document.getElementById('submitBtn').addEventListener('click', async () => {
            console.log('í‰ê°€ ì œì¶œ ì‹œë„:', { selectedType, selectedRating });

            if (!selectedType || selectedRating === 0) {
                alert('ëª¨ë“  ë¬¸í•­ì— ë‹µë³€í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                await addDoc(collection(db, 'evaluations'), {
                    awardId: currentAwardId,
                    userId: currentUserId,
                    userName: currentUserName,
                    type: selectedType,
                    rating: selectedRating,
                    timestamp: new Date()
                });

                console.log('í‰ê°€ ì œì¶œ ì™„ë£Œ');

                document.getElementById('evaluationForm').classList.add('hidden');
                document.getElementById('successState').classList.remove('hidden');

                setTimeout(() => {
                    document.getElementById('successState').classList.add('hidden');
                    document.getElementById('loadingState').classList.remove('hidden');
                    startAwardListener();
                }, 2000);

            } catch (error) {
                console.error('í‰ê°€ ì œì¶œ ì˜¤ë¥˜:', error);
                alert('í‰ê°€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });
    </script>
</body>
</html>
