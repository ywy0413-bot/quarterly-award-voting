<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Award í‰ê°€ ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-8">
            <h1 class="text-2xl md:text-3xl font-bold text-indigo-600 mb-6 md:mb-8">ğŸ† Award í‰ê°€ ê´€ë¦¬ì</h1>
            
            <!-- ì‚¬ìš©ì ë“±ë¡ ì„¹ì…˜ -->
            <div class="bg-green-50 rounded-lg p-4 md:p-6 mb-6 md:mb-8">
                <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">ğŸ‘¥ ì‚¬ìš©ì ë“±ë¡</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë¦„</label>
                            <input type="text" id="userNameInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">PIN ë²ˆí˜¸ (4ìë¦¬)</label>
                            <input type="text" id="userPinInput" maxlength="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="1234">
                        </div>
                    </div>
                    <button id="addUserBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">
                        ì‚¬ìš©ì ì¶”ê°€
                    </button>
                </div>
                
                <!-- ë“±ë¡ëœ ì‚¬ìš©ì ëª©ë¡ -->
                <div class="mt-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">ë“±ë¡ëœ ì‚¬ìš©ì (<span id="userCount">0</span>ëª…)</h3>
                    <div id="usersList" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-gray-500 text-sm">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
            
            <!-- ë°œí‘œ ì¶”ê°€ í¼ -->
            <div class="bg-indigo-50 rounded-lg p-4 md:p-6 mb-6 md:mb-8">
                <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ìƒˆ ë°œí‘œ ì¶”ê°€</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë„</label>
                            <input type="number" id="yearInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="2025" min="2020" max="2100">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ë¶„ê¸°</label>
                            <select id="quarterInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">ì„ íƒ</option>
                                <option value="Q1">Q1</option>
                                <option value="Q2">Q2</option>
                                <option value="Q3">Q3</option>
                                <option value="Q4">Q4</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì œëª©</label>
                        <input type="text" id="titleInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ì˜ˆ: ê³ ê° ê²½í—˜ ê°œì„  í”„ë¡œì íŠ¸">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ‘‘ Impact Maker</label>
                        <input type="text" id="impactMakerInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜, ì´ì˜í¬">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ’ª Core Member</label>
                        <input type="text" id="coreMemberInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ì˜ˆ: ë°•ë¯¼ìˆ˜, ì •ìˆ˜ì§„">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">âœ¨ Special Thanks</label>
                        <input type="text" id="specialThanksInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ì˜ˆ: ìµœí˜¸ì˜, ê°•ì§€ì€">
                    </div>
                    
                    <button id="addAwardBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">
                        ë°œí‘œ ì¶”ê°€í•˜ê¸°
                    </button>
                </div>
            </div>
            
            <!-- ë°œí‘œ ëª©ë¡ -->
            <div class="mb-6 md:mb-8">
                <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">ë°œí‘œ ëª©ë¡</h2>
                <div id="awardsList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center py-8">ë“±ë¡ëœ ë°œí‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </div>
            
            <!-- ê²°ê³¼ ì§‘ê³„ -->
            <div class="mt-8 pt-8 border-t">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                    <h2 class="text-lg md:text-xl font-bold text-gray-800">ğŸ“Š ê²°ê³¼ ì§‘ê³„</h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="filterYear" class="flex-1 md:flex-none px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">ì „ì²´ ì—°ë„</option>
                        </select>
                        <select id="filterQuarter" class="flex-1 md:flex-none px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">ì „ì²´ ë¶„ê¸°</option>
                            <option value="Q1">Q1</option>
                            <option value="Q2">Q2</option>
                            <option value="Q3">Q3</option>
                            <option value="Q4">Q4</option>
                        </select>
                    </div>
                </div>
                <div id="resultsSection" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center py-8">í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </div>
            
            <!-- í‰ê°€ ë°ì´í„° ë‹¤ìš´ë¡œë“œ -->
            <div class="mt-8 pt-8 border-t">
                <button id="downloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
                    <span>ğŸ“¥</span>
                    <span>í‰ê°€ ë°ì´í„° ë‹¤ìš´ë¡œë“œ (CSV)</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC23FHBCtNPXXekdPgeYJZOyHU8SwIHWU",
            authDomain: "quarterly-award-voting.firebaseapp.com",
            projectId: "quarterly-award-voting",
            storageBucket: "quarterly-award-voting.firebasestorage.app",
            messagingSenderId: "1057289910549",
            appId: "1:1057289910549:web:e0d79116ad23e3f670911c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let usersCache = [];
        let awardsCache = [];
        let evaluationsCache = [];

        // ì‚¬ìš©ì ì¶”ê°€
        document.getElementById('addUserBtn').addEventListener('click', async () => {
            const name = document.getElementById('userNameInput').value.trim();
            const pin = document.getElementById('userPinInput').value.trim();

            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                alert('4ìë¦¬ ìˆ«ì PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // ì¤‘ë³µ ì²´í¬
            if (usersCache.some(u => u.name === name)) {
                alert('ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤!');
                return;
            }

            try {
                await addDoc(collection(db, 'users'), {
                    name,
                    pin,
                    createdAt: new Date()
                });

                document.getElementById('userNameInput').value = '';
                document.getElementById('userPinInput').value = '';
                alert('ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('Error:', error);
                alert('ì‚¬ìš©ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì‚¬ìš©ì ëª©ë¡ ì‹¤ì‹œê°„ ë¡œë“œ
        onSnapshot(collection(db, 'users'), (snapshot) => {
            usersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const usersList = document.getElementById('usersList');
            const userCount = document.getElementById('userCount');
            
            if (usersCache.length === 0) {
                usersList.innerHTML = '<p class="text-gray-500 text-sm">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                userCount.textContent = '0';
                return;
            }

            userCount.textContent = usersCache.length;
            usersList.innerHTML = '';
            
            usersCache.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex justify-between items-center bg-white p-2 rounded border';
                userElement.innerHTML = `
                    <span class="text-sm">${user.name} (PIN: ${user.pin})</span>
                    <button onclick="deleteUser('${user.id}')" class="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
                `;
                usersList.appendChild(userElement);
            });
        });

        // ì‚¬ìš©ì ì‚­ì œ
        window.deleteUser = async (userId) => {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await deleteDoc(doc(db, 'users', userId));
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ë°œí‘œ ì¶”ê°€
        document.getElementById('addAwardBtn').addEventListener('click', async () => {
            const year = document.getElementById('yearInput').value.trim();
            const quarter = document.getElementById('quarterInput').value;
            const title = document.getElementById('titleInput').value.trim();
            const impactMaker = document.getElementById('impactMakerInput').value.trim();
            const coreMember = document.getElementById('coreMemberInput').value.trim();
            const specialThanks = document.getElementById('specialThanksInput').value.trim();

            if (!year) {
                alert('ì—°ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!quarter) {
                alert('ë¶„ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                await addDoc(collection(db, 'awards'), {
                    year,
                    quarter,
                    title,
                    impactMaker,
                    coreMember,
                    specialThanks,
                    isActive: false,
                    createdAt: new Date()
                });

                document.getElementById('yearInput').value = '';
                document.getElementById('quarterInput').value = '';
                document.getElementById('titleInput').value = '';
                document.getElementById('impactMakerInput').value = '';
                document.getElementById('coreMemberInput').value = '';
                document.getElementById('specialThanksInput').value = '';

                alert('ë°œí‘œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('Error:', error);
                alert('ë°œí‘œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ë°œí‘œ ëª©ë¡ ì‹¤ì‹œê°„ ë¡œë“œ
        onSnapshot(query(collection(db, 'awards'), orderBy('createdAt', 'desc')), (snapshot) => {
            awardsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateYearFilter();
            loadAwards();
        });

        // í‰ê°€ ëª©ë¡ ì‹¤ì‹œê°„ ë¡œë“œ
        onSnapshot(collection(db, 'evaluations'), (snapshot) => {
            evaluationsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            loadResults();
        });

        // ì—°ë„ í•„í„° ì—…ë°ì´íŠ¸
        function updateYearFilter() {
            const yearSet = new Set(awardsCache.map(a => a.year));
            const filterYear = document.getElementById('filterYear');
            
            const currentValue = filterYear.value;
            filterYear.innerHTML = '<option value="">ì „ì²´ ì—°ë„</option>';
            
            Array.from(yearSet).sort().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ë…„';
                filterYear.appendChild(option);
            });
            
            if (currentValue) {
                filterYear.value = currentValue;
            }
        }

        // í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
        document.getElementById('filterYear').addEventListener('change', loadResults);
        document.getElementById('filterQuarter').addEventListener('change', loadResults);

        // ë°œí‘œ ëª©ë¡ í‘œì‹œ
        function loadAwards() {
            const awardsList = document.getElementById('awardsList');
            
            if (awardsCache.length === 0) {
                awardsList.innerHTML = '<p class="text-gray-500 text-center py-8">ë“±ë¡ëœ ë°œí‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            awardsList.innerHTML = '';
            
            awardsCache.forEach(award => {
                const awardElement = document.createElement('div');
                awardElement.className = 'bg-white border-2 border-gray-200 rounded-lg p-4';
                
                awardElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-sm text-gray-500 font-semibold">${award.year} ${award.quarter}</span>
                            <h3 class="text-base md:text-lg font-bold text-gray-800">${award.title}</h3>
                        </div>
                        <span class="px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-semibold ${award.isActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                            ${award.isActive ? 'âœ… ì§„í–‰ ì¤‘' : 'ëŒ€ê¸°'}
                        </span>
                    </div>
                    <div class="text-xs md:text-sm text-gray-600 space-y-1 mb-4">
                        <p><span class="font-semibold">ğŸ‘‘ Impact Maker:</span> ${award.impactMaker || '-'}</p>
                        <p><span class="font-semibold">ğŸ’ª Core Member:</span> ${award.coreMember || '-'}</p>
                        <p><span class="font-semibold">âœ¨ Special Thanks:</span> ${award.specialThanks || '-'}</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-2">
                        <button onclick="toggleActive('${award.id}', ${award.isActive})" class="flex-1 ${award.isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-500 hover:bg-indigo-600'} text-white py-2 rounded-lg transition text-sm">
                            ${award.isActive ? 'í‰ê°€ ì¢…ë£Œ' : 'í‰ê°€ ì‹œì‘'}
                        </button>
                        <button onclick="resetEvaluations('${award.id}')" class="flex-1 md:flex-none md:px-4 bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-lg transition text-sm">
                            í‰ê°€ ì´ˆê¸°í™”
                        </button>
                        <button onclick="deleteAward('${award.id}')" class="flex-1 md:flex-none md:px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg transition text-sm">
                            ì‚­ì œ
                        </button>
                    </div>
                `;
                
                awardsList.appendChild(awardElement);
            });
        }

        // í‰ê°€ ì‹œì‘/ì¢…ë£Œ
        window.toggleActive = async (awardId, currentStatus) => {
            try {
                // ëª¨ë“  ë°œí‘œë¥¼ ë¹„í™œì„±í™”
                const updatePromises = awardsCache.map(award => 
                    updateDoc(doc(db, 'awards', award.id), { isActive: false })
                );
                await Promise.all(updatePromises);

                // ì„ íƒí•œ ë°œí‘œë§Œ í™œì„±í™” (ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš°)
                if (!currentStatus) {
                    await updateDoc(doc(db, 'awards', awardId), { isActive: true });
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // í‰ê°€ ì´ˆê¸°í™”
        window.resetEvaluations = async (awardId) => {
            if (!confirm('ì´ Awardì˜ ëª¨ë“  í‰ê°€ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;

            try {
                const q = query(collection(db, 'evaluations'), where('awardId', '==', awardId));
                const snapshot = await getDocs(q);
                
                const deletePromises = snapshot.docs.map(docSnap => deleteDoc(docSnap.ref));
                await Promise.all(deletePromises);
                
                alert('í‰ê°€ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Error:', error);
                alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ë°œí‘œ ì‚­ì œ
        window.deleteAward = async (awardId) => {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await deleteDoc(doc(db, 'awards', awardId));
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ê²°ê³¼ ì§‘ê³„ í‘œì‹œ
        function loadResults() {
            const resultsSection = document.getElementById('resultsSection');
            const filterYear = document.getElementById('filterYear').value;
            const filterQuarter = document.getElementById('filterQuarter').value;
            
            if (evaluationsCache.length === 0) {
                resultsSection.innerHTML = '<p class="text-gray-500 text-center py-8">í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            let filteredAwards = awardsCache;
            if (filterYear) {
                filteredAwards = filteredAwards.filter(a => a.year === filterYear);
            }
            if (filterQuarter) {
                filteredAwards = filteredAwards.filter(a => a.quarter === filterQuarter);
            }

            if (filteredAwards.length === 0) {
                resultsSection.innerHTML = '<p class="text-gray-500 text-center py-8">í•´ë‹¹ ì¡°ê±´ì˜ ë°œí‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            resultsSection.innerHTML = '';
            let hasData = false;
            
            filteredAwards.forEach(award => {
                const awardEvals = evaluationsCache.filter(e => e.awardId === award.id);
                
                if (awardEvals.length === 0) return;
                
                hasData = true;
                
                const ratingDist = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, unknown: 0 };
                let ratingSum = 0;
                let ratingCount = 0;
                
                awardEvals.forEach(e => {
                    if (e.rating === -1) {
                        ratingDist.unknown++;
                    } else {
                        ratingDist[e.rating]++;
                        ratingSum += e.rating;
                        ratingCount++;
                    }
                });
                
                const avgRating = ratingCount > 0 ? (ratingSum / ratingCount).toFixed(2) : 0;
                
                const typeDist = {};
                awardEvals.forEach(e => {
                    typeDist[e.type] = (typeDist[e.type] || 0) + 1;
                });
                
                const resultCard = document.createElement('div');
                resultCard.className = 'bg-blue-50 rounded-lg p-4 md:p-6 border-2 border-blue-200';
                
                resultCard.innerHTML = `
                    <div class="mb-4">
                        <span class="text-xs md:text-sm text-gray-600 font-semibold">${award.year} ${award.quarter}</span>
                        <h3 class="text-base md:text-lg font-bold text-gray-800">${award.title}</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-white rounded p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs md:text-sm font-semibold text-gray-700">ğŸ“‹ í‰ê°€ ì¸ì›</span>
                                <span class="text-base md:text-lg font-bold text-indigo-600">${awardEvals.length}ëª…</span>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded p-3">
                            <div class="text-xs md:text-sm font-semibold text-gray-700 mb-2">ğŸ† Award ìœ í˜•</div>
                            <div class="space-y-1 text-xs md:text-sm">
                                <div class="flex justify-between">
                                    <span>ğŸ’ª ë…¸ë ¥í˜•</span>
                                    <span class="font-semibold">${typeDist['ë…¸ë ¥í˜•'] || 0}ëª…</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ğŸš€ í˜ì‹ í˜•</span>
                                    <span class="font-semibold">${typeDist['í˜ì‹ í˜•'] || 0}ëª…</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ğŸ¨ ì°½ì¡°í˜•</span>
                                    <span class="font-semibold">${typeDist['ì°½ì¡°í˜•'] || 0}ëª…</span>
                                </div>
                                <div class="flex justify-between text-gray-500">
                                    <span>â“ ì˜ ëª¨ë¥´ê² ìŒ</span>
                                    <span class="font-semibold">${typeDist['ì˜ ëª¨ë¥´ê² ìŒ'] || 0}ëª…</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded p-3">
                            <div class="text-xs md:text-sm font-semibold text-gray-700 mb-2">â­ ì˜í–¥ë ¥ í‰ê°€ (í‰ê· : ${avgRating}ì )</div>
                            <div class="space-y-1 text-xs md:text-sm">
                                <div class="flex justify-between">
                                    <span>â­ 1ì </span>
                                    <span class="font-semibold">${ratingDist[1]}ëª…</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>â­â­ 2ì </span>
                                    <span class="font-semibold">${ratingDist[2]}ëª…</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>â­â­â­ 3ì </span>
                                    <span class="font-semibold">${ratingDist[3]}ëª…</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>â­â­â­â­ 4ì </span>
                                    <span class="font-semibold">${ratingDist[4]}ëª…</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>â­â­â­â­â­ 5ì </span>
                                    <span class="font-semibold">${ratingDist[5]}ëª…</span>
                                </div>
                                <div class="flex justify-between text-gray-500">
                                    <span>â“ ì˜ ëª¨ë¥´ê² ìŒ</span>
                                    <span class="font-semibold">${ratingDist.unknown}ëª…</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                resultsSection.appendChild(resultCard);
            });

            if (!hasData) {
                resultsSection.innerHTML = '<p class="text-gray-500 text-center py-8">í•´ë‹¹ ì¡°ê±´ì˜ í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            }
        }

        // CSV ë‹¤ìš´ë¡œë“œ
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            if (evaluationsCache.length === 0) {
                alert('ì•„ì§ í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const awards = {};
            awardsCache.forEach(award => {
                awards[award.id] = `${award.year} ${award.quarter} - ${award.title}`;
            });

            let csv = '\uFEFFì—°ë„-ë¶„ê¸°,Award ì œëª©,í‰ê°€ì,Award ìœ í˜•,ì˜í–¥ë ¥ ì ìˆ˜,í‰ê°€ ì‹œê°„\n';

            evaluationsCache.forEach(eval => {
                const awardTitle = awards[eval.awardId] || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const rating = eval.rating === -1 ? 'ì˜ ëª¨ë¥´ê² ìŒ' : eval.rating;
                const timestamp = eval.timestamp?.toDate ? eval.timestamp.toDate().toLocaleString('ko-KR') : new Date(eval.timestamp).toLocaleString('ko-KR');
                
                csv += `"${awardTitle}","${eval.userName}","${eval.type}","${rating}","${timestamp}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `award_evaluations_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
        });
    </script>
</body>
</html>
