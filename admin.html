<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Award í‰ê°€ ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="adminLoginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <h1 class="text-3xl font-bold text-indigo-600 mb-6 text-center">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPasswordInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                </div>
                <button id="adminLoginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">
                    ë¡œê·¸ì¸
                </button>
                <p class="text-xs text-gray-500 text-center">ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸: admin1234</p>
            </div>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ë©”ì¸ í™”ë©´ -->
    <div id="adminMainScreen" class="hidden container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-indigo-600">ğŸ† Award í‰ê°€ ê´€ë¦¬ì</h1>
                <button id="adminLogoutBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>

            <!-- localStorage ë§ˆì´ê·¸ë ˆì´ì…˜ ì•Œë¦¼ -->
            <div id="migrationAlert" class="hidden bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6 mb-8">
                <h3 class="text-lg font-bold text-yellow-800 mb-2">âš ï¸ localStorage ë°ì´í„° ë°œê²¬!</h3>
                <p class="text-yellow-700 mb-4">ì´ì „ localStorage ë°ì´í„°ë¥¼ Firebaseë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="flex gap-3">
                    <button id="migrateBtn" class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition">
                        ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
                    </button>
                    <button id="skipMigrationBtn" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition">
                        ê±´ë„ˆë›°ê¸°
                    </button>
                </div>
            </div>

            <!-- íƒ­ ë©”ë‰´ -->
            <div class="flex flex-wrap gap-2 mb-6 border-b">
                <button class="tab-btn px-6 py-3 font-semibold border-b-2 border-indigo-600 text-indigo-600" data-tab="users">
                    ì‚¬ìš©ì ê´€ë¦¬
                </button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-gray-700" data-tab="awards">
                    Award ê´€ë¦¬
                </button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-gray-700" data-tab="results">
                    í‰ê°€ ê²°ê³¼
                </button>
            </div>

            <!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
            <div id="usersTab" class="tab-content">
                <div class="bg-indigo-50 rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ìƒˆ ì‚¬ìš©ì ë“±ë¡</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="userNameInput" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì´ë¦„">
                        <input type="number" id="userPinInput" inputmode="numeric" maxlength="4" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="4ìë¦¬ PIN">
                        <button id="addUserBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition">
                            ë“±ë¡í•˜ê¸°
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ë“±ë¡ëœ ì‚¬ìš©ì (<span id="userCount">0</span>ëª…)</h2>
                    <div id="usersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-gray-500 col-span-full text-center py-8">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <!-- Award ê´€ë¦¬ íƒ­ -->
            <div id="awardsTab" class="tab-content hidden">
                <div class="bg-indigo-50 rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ìƒˆ ë°œí‘œ ì¶”ê°€</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë„</label>
                                <input type="number" id="yearInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: 2025">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ë¶„ê¸°</label>
                                <select id="quarterInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ì œëª©</label>
                            <input type="text" id="titleInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: ê³ ê° ê²½í—˜ ê°œì„  í”„ë¡œì íŠ¸">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ‘‘ Impact Maker</label>
                            <input type="text" id="impactMakerInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜, ì´ì˜í¬">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ’ª Core Member</label>
                            <input type="text" id="coreMemberInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: ë°•ë¯¼ìˆ˜, ì •ìˆ˜ì§„">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">âœ¨ Special Thanks</label>
                            <input type="text" id="specialThanksInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: ìµœí˜¸ì˜, ê°•ì§€ì€">
                        </div>
                        <button id="addAwardBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">
                            ë°œí‘œ ì¶”ê°€í•˜ê¸°
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ë°œí‘œ ëª©ë¡</h2>
                    <div id="awardsList" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">ë“±ë¡ëœ ë°œí‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <!-- í‰ê°€ ê²°ê³¼ íƒ­ -->
            <div id="resultsTab" class="tab-content hidden">
                <div class="bg-indigo-50 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">í•„í„°</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë„</label>
                            <select id="filterYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ë¶„ê¸°</label>
                            <select id="filterQuarter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">ì „ì²´</option>
                                <option value="Q1">Q1</option>
                                <option value="Q2">Q2</option>
                                <option value="Q3">Q3</option>
                                <option value="Q4">Q4</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="downloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition">
                                ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>
                </div>

                <div id="resultsContainer">
                    <p class="text-gray-500 text-center py-8">í‰ê°€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC23FHBCtNPXXekdPgeYJZOyHU8SwIHWU",
            authDomain: "quarterly-award-voting.firebaseapp.com",
            projectId: "quarterly-award-voting",
            storageBucket: "quarterly-award-voting.firebasestorage.app",
            messagingSenderId: "1057289910549",
            appId: "1:1057289910549:web:e0d79116ad23e3f670911c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const ADMIN_PASSWORD = "admin1234";
        let isLoggedIn = false;

        // PIN ì…ë ¥ 4ìë¦¬ ì œí•œ
        document.getElementById('userPinInput').addEventListener('input', (e) => {
            if (e.target.value.length > 4) {
                e.target.value = e.target.value.slice(0, 4);
            }
        });

        // ê´€ë¦¬ì ë¡œê·¸ì¸
        document.getElementById('adminLoginBtn').addEventListener('click', () => {
            const password = document.getElementById('adminPasswordInput').value;

            if (password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                document.getElementById('adminLoginScreen').classList.add('hidden');
                document.getElementById('adminMainScreen').classList.remove('hidden');

                // localStorage ë°ì´í„° ì²´í¬
                checkForLocalStorageData();

                // ë°ì´í„° ë¡œë“œ
                loadUsers();
                loadAwards();
                loadResults();
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤!');
            }
        });

        // ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ
        document.getElementById('adminLogoutBtn').addEventListener('click', () => {
            isLoggedIn = false;
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('adminLoginScreen').classList.remove('hidden');
            document.getElementById('adminMainScreen').classList.add('hidden');
        });

        // localStorage ë°ì´í„° í™•ì¸
        function checkForLocalStorageData() {
            const oldData = localStorage.getItem('awardVotingState');

            if (oldData) {
                console.log('localStorage ë°ì´í„° ë°œê²¬!');
                document.getElementById('migrationAlert').classList.remove('hidden');
            }
        }

        // ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
        document.getElementById('migrateBtn').addEventListener('click', async () => {
            try {
                const oldData = JSON.parse(localStorage.getItem('awardVotingState'));
                console.log('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘:', oldData);

                let migratedCount = 0;

                // ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜
                if (oldData.users && oldData.users.length > 0) {
                    for (const user of oldData.users) {
                        try {
                            await addDoc(collection(db, 'users'), {
                                name: user.name,
                                pin: user.pin,
                                createdAt: new Date()
                            });
                            migratedCount++;
                            console.log('ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ:', user.name);
                        } catch (error) {
                            console.error('ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜:', user.name, error);
                        }
                    }
                }

                // Award ë§ˆì´ê·¸ë ˆì´ì…˜
                if (oldData.awards && oldData.awards.length > 0) {
                    for (const award of oldData.awards) {
                        try {
                            await addDoc(collection(db, 'awards'), {
                                title: award.title,
                                impactMaker: award.impactMaker || '',
                                coreMember: award.coreMember || '',
                                specialThanks: award.specialThanks || '',
                                year: award.year || '',
                                quarter: award.quarter || '',
                                isActive: award.isActive || false,
                                createdAt: new Date()
                            });
                            migratedCount++;
                            console.log('Award ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ:', award.title);
                        } catch (error) {
                            console.error('Award ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜:', award.title, error);
                        }
                    }
                }

                // í‰ê°€ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
                if (oldData.evaluations && oldData.evaluations.length > 0) {
                    for (const evaluation of oldData.evaluations) {
                        try {
                            await addDoc(collection(db, 'evaluations'), {
                                awardId: evaluation.awardId,
                                userId: evaluation.userId,
                                userName: evaluation.userName || '',
                                type: evaluation.type,
                                rating: evaluation.rating,
                                timestamp: new Date(evaluation.timestamp)
                            });
                            migratedCount++;
                            console.log('í‰ê°€ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
                        } catch (error) {
                            console.error('í‰ê°€ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜:', error);
                        }
                    }
                }

                // ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„ localStorage ì‚­ì œ
                localStorage.removeItem('awardVotingState');
                document.getElementById('migrationAlert').classList.add('hidden');

                alert(`ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!\nì´ ${migratedCount}ê°œ í•­ëª©ì´ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                loadUsers();
                loadAwards();
                loadResults();

            } catch (error) {
                console.error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜:', error);
                alert('ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ë§ˆì´ê·¸ë ˆì´ì…˜ ê±´ë„ˆë›°ê¸°
        document.getElementById('skipMigrationBtn').addEventListener('click', () => {
            document.getElementById('migrationAlert').classList.add('hidden');
        });

        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;

                // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-b-2', 'border-indigo-600', 'text-indigo-600');
                    b.classList.add('text-gray-500');
                });
                btn.classList.add('border-b-2', 'border-indigo-600', 'text-indigo-600');
                btn.classList.remove('text-gray-500');

                // íƒ­ ì»¨í…ì¸  í‘œì‹œ/ìˆ¨ê¹€
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tabName + 'Tab').classList.remove('hidden');
            });
        });

        // ì‚¬ìš©ì ë“±ë¡
        document.getElementById('addUserBtn').addEventListener('click', async () => {
            const name = document.getElementById('userNameInput').value.trim();
            const pin = document.getElementById('userPinInput').value.trim();

            console.log('ì‚¬ìš©ì ë“±ë¡ ì‹œë„:', { name, pin });

            if (!name || !pin) {
                alert('ì´ë¦„ê³¼ PINì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (pin.length !== 4) {
                alert('PINì€ 4ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            try {
                await addDoc(collection(db, 'users'), {
                    name,
                    pin,
                    createdAt: new Date()
                });

                console.log('ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ:', name);

                document.getElementById('userNameInput').value = '';
                document.getElementById('userPinInput').value = '';

                alert('ì‚¬ìš©ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì‚¬ìš©ì ë“±ë¡ ì˜¤ë¥˜:', error);
                alert('ì‚¬ìš©ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ (ì‹¤ì‹œê°„)
        function loadUsers() {
            onSnapshot(collection(db, 'users'), (snapshot) => {
                console.log('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ:', snapshot.size, 'ëª…');

                const usersList = document.getElementById('usersList');
                document.getElementById('userCount').textContent = snapshot.size;

                if (snapshot.empty) {
                    usersList.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }

                usersList.innerHTML = '';

                // ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                users.sort((a, b) => a.name.localeCompare(b.name, 'ko'));

                users.forEach(({ id, name, pin }) => {
                    const userElement = document.createElement('div');
                    userElement.className = 'bg-white border-2 border-gray-200 rounded-lg p-4 flex justify-between items-center';
                    userElement.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">${name}</p>
                            <p class="text-sm text-gray-500">PIN: ${pin}</p>
                        </div>
                        <button onclick="deleteUser('${id}', '${name}')" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition">
                            ì‚­ì œ
                        </button>
                    `;
                    usersList.appendChild(userElement);
                });
            });
        }

        // ì‚¬ìš©ì ì‚­ì œ
        window.deleteUser = async (userId, userName) => {
            if (!confirm(`"${userName}" ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                await deleteDoc(doc(db, 'users', userId));
                console.log('ì‚¬ìš©ì ì‚­ì œ ì™„ë£Œ:', userName);
            } catch (error) {
                console.error('ì‚¬ìš©ì ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // Award ì¶”ê°€
        document.getElementById('addAwardBtn').addEventListener('click', async () => {
            const year = document.getElementById('yearInput').value.trim();
            const quarter = document.getElementById('quarterInput').value;
            const title = document.getElementById('titleInput').value.trim();
            const impactMaker = document.getElementById('impactMakerInput').value.trim();
            const coreMember = document.getElementById('coreMemberInput').value.trim();
            const specialThanks = document.getElementById('specialThanksInput').value.trim();

            console.log('Award ì¶”ê°€ ì‹œë„:', { year, quarter, title });

            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                await addDoc(collection(db, 'awards'), {
                    year,
                    quarter,
                    title,
                    impactMaker,
                    coreMember,
                    specialThanks,
                    isActive: false,
                    createdAt: new Date()
                });

                console.log('Award ì¶”ê°€ ì™„ë£Œ:', title);

                document.getElementById('yearInput').value = '';
                document.getElementById('quarterInput').value = '';
                document.getElementById('titleInput').value = '';
                document.getElementById('impactMakerInput').value = '';
                document.getElementById('coreMemberInput').value = '';
                document.getElementById('specialThanksInput').value = '';

                alert('ë°œí‘œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('Award ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ë°œí‘œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // Award ëª©ë¡ ë¡œë“œ (ì‹¤ì‹œê°„)
        function loadAwards() {
            const q = query(collection(db, 'awards'), orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                console.log('Award ëª©ë¡ ë¡œë“œ:', snapshot.size, 'ê°œ');

                const awardsList = document.getElementById('awardsList');

                if (snapshot.empty) {
                    awardsList.innerHTML = '<p class="text-gray-500 text-center py-8">ë“±ë¡ëœ ë°œí‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }

                awardsList.innerHTML = '';

                snapshot.forEach(awardDoc => {
                    const award = awardDoc.data();
                    const awardElement = document.createElement('div');
                    awardElement.className = 'bg-white border-2 border-gray-200 rounded-lg p-4';

                    awardElement.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800">${award.title}</h3>
                                <p class="text-sm text-indigo-600 font-semibold">${award.year || ''} ${award.quarter || ''}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${award.isActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                                ${award.isActive ? 'í‰ê°€ ì§„í–‰ ì¤‘' : 'ëŒ€ê¸°'}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1 mb-4">
                            <p><span class="font-semibold">ğŸ‘‘ Impact Maker:</span> ${award.impactMaker || '-'}</p>
                            <p><span class="font-semibold">ğŸ’ª Core Member:</span> ${award.coreMember || '-'}</p>
                            <p><span class="font-semibold">âœ¨ Special Thanks:</span> ${award.specialThanks || '-'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleActive('${awardDoc.id}', ${award.isActive})" class="flex-1 ${award.isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-500 hover:bg-indigo-600'} text-white py-2 rounded-lg transition">
                                ${award.isActive ? 'í‰ê°€ ì¢…ë£Œ' : 'í‰ê°€ ì‹œì‘'}
                            </button>
                            <button onclick="resetAwardEvaluations('${awardDoc.id}', '${award.title}')" class="px-4 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg transition">
                                ì´ˆê¸°í™”
                            </button>
                            <button onclick="deleteAward('${awardDoc.id}', '${award.title}')" class="px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition">
                                ì‚­ì œ
                            </button>
                        </div>
                    `;

                    awardsList.appendChild(awardElement);
                });
            });
        }

        // í‰ê°€ ì‹œì‘/ì¢…ë£Œ
        window.toggleActive = async (awardId, currentStatus) => {
            try {
                // ë‹¤ë¥¸ ëª¨ë“  ë°œí‘œë¥¼ ë¹„í™œì„±í™”
                const snapshot = await getDocs(collection(db, 'awards'));
                const updatePromises = snapshot.docs.map(awardDoc =>
                    updateDoc(awardDoc.ref, { isActive: false })
                );
                await Promise.all(updatePromises);

                // ì„ íƒí•œ ë°œí‘œë§Œ í™œì„±í™” (ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš°)
                if (!currentStatus) {
                    await updateDoc(doc(db, 'awards', awardId), { isActive: true });
                }

                console.log('Award í™œì„±í™” ìƒíƒœ ë³€ê²½ ì™„ë£Œ');
            } catch (error) {
                console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // Awardë³„ í‰ê°€ ì´ˆê¸°í™”
        window.resetAwardEvaluations = async (awardId, awardTitle) => {
            if (!confirm(`"${awardTitle}" Awardì˜ ëª¨ë“  í‰ê°€ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const q = query(collection(db, 'evaluations'), where('awardId', '==', awardId));
                const snapshot = await getDocs(q);

                const deletePromises = snapshot.docs.map(evaluationDoc =>
                    deleteDoc(evaluationDoc.ref)
                );
                await Promise.all(deletePromises);

                console.log('í‰ê°€ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ:', awardTitle);
                alert(`${snapshot.size}ê°œì˜ í‰ê°€ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

                loadResults();
            } catch (error) {
                console.error('í‰ê°€ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('í‰ê°€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // Award ì‚­ì œ
        window.deleteAward = async (awardId, awardTitle) => {
            if (!confirm(`"${awardTitle}" Awardë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                // Awardì™€ ê´€ë ¨ëœ í‰ê°€ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œ
                const q = query(collection(db, 'evaluations'), where('awardId', '==', awardId));
                const evaluationSnapshot = await getDocs(q);

                const deletePromises = evaluationSnapshot.docs.map(evaluationDoc => deleteDoc(evaluationDoc.ref));
                await Promise.all(deletePromises);

                await deleteDoc(doc(db, 'awards', awardId));

                console.log('Award ì‚­ì œ ì™„ë£Œ:', awardTitle);
            } catch (error) {
                console.error('Award ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // í‰ê°€ ê²°ê³¼ ë¡œë“œ
        async function loadResults() {
            try {
                const awardsSnapshot = await getDocs(collection(db, 'awards'));
                const evaluationsSnapshot = await getDocs(collection(db, 'evaluations'));

                const awards = {};
                const years = new Set();

                awardsSnapshot.forEach(awardDoc => {
                    const award = awardDoc.data();
                    awards[awardDoc.id] = award;
                    if (award.year) years.add(award.year);
                });

                // ì—°ë„ í•„í„° ì—…ë°ì´íŠ¸
                const yearFilter = document.getElementById('filterYear');
                yearFilter.innerHTML = '<option value="">ì „ì²´</option>';
                Array.from(years).sort().forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });

                // ê²°ê³¼ í‘œì‹œ
                displayResults(awards, evaluationsSnapshot);

                // í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.getElementById('filterYear').addEventListener('change', () => {
                    displayResults(awards, evaluationsSnapshot);
                });
                document.getElementById('filterQuarter').addEventListener('change', () => {
                    displayResults(awards, evaluationsSnapshot);
                });

            } catch (error) {
                console.error('ê²°ê³¼ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function displayResults(awards, evaluationsSnapshot) {
            const filterYear = document.getElementById('filterYear').value;
            const filterQuarter = document.getElementById('filterQuarter').value;
            const resultsContainer = document.getElementById('resultsContainer');

            // Awardë³„ë¡œ í‰ê°€ ë°ì´í„° ê·¸ë£¹í™”
            const awardResults = {};

            evaluationsSnapshot.forEach(evaluationDoc => {
                const evaluation = evaluationDoc.data();
                const award = awards[evaluation.awardId];

                if (!award) return;

                // í•„í„° ì ìš©
                if (filterYear && award.year !== filterYear) return;
                if (filterQuarter && award.quarter !== filterQuarter) return;

                if (!awardResults[evaluation.awardId]) {
                    awardResults[evaluation.awardId] = {
                        award: award,
                        evaluations: []
                    };
                }

                awardResults[evaluation.awardId].evaluations.push(evaluation);
            });

            if (Object.keys(awardResults).length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">í‰ê°€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            resultsContainer.innerHTML = '';

            Object.entries(awardResults).forEach(([awardId, { award, evaluations }]) => {
                // í†µê³„ ê³„ì‚°
                const totalCount = evaluations.length;
                const ratingSum = evaluations.reduce((sum, e) => sum + (e.rating > 0 ? e.rating : 0), 0);
                const ratingCount = evaluations.filter(e => e.rating > 0).length;
                const avgRating = ratingCount > 0 ? (ratingSum / ratingCount).toFixed(2) : 'ì—†ìŒ';

                const typeCount = {
                    'ë…¸ë ¥í˜•': evaluations.filter(e => e.type === 'ë…¸ë ¥í˜•').length,
                    'í˜ì‹ í˜•': evaluations.filter(e => e.type === 'í˜ì‹ í˜•').length,
                    'ì°½ì¡°í˜•': evaluations.filter(e => e.type === 'ì°½ì¡°í˜•').length,
                    'ì˜ ëª¨ë¥´ê² ìŒ': evaluations.filter(e => e.type === 'ì˜ ëª¨ë¥´ê² ìŒ').length
                };

                const resultElement = document.createElement('div');
                resultElement.className = 'bg-white border-2 border-gray-200 rounded-lg p-6 mb-4';
                resultElement.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-gray-800">${award.title}</h3>
                        <p class="text-sm text-indigo-600 font-semibold">${award.year || ''} ${award.quarter || ''}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-semibold text-gray-700 mb-2">ğŸ“Š í‰ê°€ í†µê³„</p>
                            <div class="bg-gray-50 rounded p-3 space-y-1 text-sm">
                                <p><span class="font-semibold">ì´ í‰ê°€ ìˆ˜:</span> ${totalCount}ëª…</p>
                                <p><span class="font-semibold">í‰ê·  ì˜í–¥ë ¥:</span> ${avgRating}ì </p>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-700 mb-2">ğŸ† Award ìœ í˜•</p>
                            <div class="bg-gray-50 rounded p-3 space-y-1 text-sm">
                                <p>ğŸ’ª ë…¸ë ¥í˜•: ${typeCount['ë…¸ë ¥í˜•']}ëª…</p>
                                <p>ğŸš€ í˜ì‹ í˜•: ${typeCount['í˜ì‹ í˜•']}ëª…</p>
                                <p>ğŸ¨ ì°½ì¡°í˜•: ${typeCount['ì°½ì¡°í˜•']}ëª…</p>
                                <p>â“ ì˜ ëª¨ë¥´ê² ìŒ: ${typeCount['ì˜ ëª¨ë¥´ê² ìŒ']}ëª…</p>
                            </div>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(resultElement);
            });
        }

        // CSV ë‹¤ìš´ë¡œë“œ
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            try {
                const filterYear = document.getElementById('filterYear').value;
                const filterQuarter = document.getElementById('filterQuarter').value;

                const awardsSnapshot = await getDocs(collection(db, 'awards'));
                const evaluationsSnapshot = await getDocs(collection(db, 'evaluations'));

                const awards = {};
                awardsSnapshot.forEach(awardDoc => {
                    awards[awardDoc.id] = awardDoc.data();
                });

                let csv = 'ì—°ë„,ë¶„ê¸°,Award ì œëª©,í‰ê°€ì,Award ìœ í˜•,ì˜í–¥ë ¥ ì ìˆ˜,í‰ê°€ ì‹œê°„\n';

                evaluationsSnapshot.forEach(evaluationDoc => {
                    const evaluation = evaluationDoc.data();
                    const award = awards[evaluation.awardId];

                    if (!award) return;

                    // í•„í„° ì ìš©
                    if (filterYear && award.year !== filterYear) return;
                    if (filterQuarter && award.quarter !== filterQuarter) return;

                    const year = award.year || '';
                    const quarter = award.quarter || '';
                    const awardTitle = award.title || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const userName = evaluation.userName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const type = evaluation.type || '';
                    const rating = evaluation.rating === -1 ? 'ì˜ ëª¨ë¥´ê² ìŒ' : evaluation.rating;
                    const timestamp = evaluation.timestamp?.toDate().toLocaleString('ko-KR') || '';

                    csv += `"${year}","${quarter}","${awardTitle}","${userName}","${type}","${rating}","${timestamp}"\n`;
                });

                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `award_evaluations_${new Date().toISOString().split('T')[0]}.csv`);
                link.click();

                console.log('CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('CSV ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    </script>
</body>
</html>
